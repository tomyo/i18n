<!DOCTYPE html>
<meta lang="en">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<h2>Running useI18n tests...</h2>

<iframe src="" title="Testing sandbox"></iframe>

<details>
  <summary style="cursor:default">Summary (+ info)</summary>
  <ul></ul>
</details>

<script type="module">
  const testsPaths = [
    'should-translate',
    'should-handle-missing-translations',
  ].map((name) => `${name}.html`);

  const iframe = document.querySelector('iframe');
  const finishedTestBroadcast = new BroadcastChannel('tests');
  let currentPath, timeoutID;

  finishedTestBroadcast.onmessage = (event) => {
    // Tests finished running for `currentPath`
    clearTimeout(timeoutID);

    appendReportToSummary(currentPath, event.data)

    if (testsPaths.length) {
      runNextTest()
    } else {
      document.querySelector('h2').innerText += '  âœ” [Done]'
      console.info('[Done] All tests finished succesfully!');
    }
  }

  function runNextTest() {
    currentPath = testsPaths.shift();
    console.info(`Testing ${currentPath} ...`)
    iframe.contentWindow.location.replace(currentPath); // keep history clean
    timeoutID = setupTimeOutError();
  }

  function setupTimeOutError() {
    iframe.style.backgroundColor = "inherited";
    return setTimeout(() => {
      iframe.style.backgroundColor = 'lightcoral';
      document.querySelector('h2').innerText += '  X [Failed]'
      console.warn(`Test failed: ${currentPath}`);
    }, 3000);
  }

  function appendReportToSummary(testId, data) {
    const summaryList = document.querySelector('details ul');
    const li = document.createElement('li');

    li.innerHTML = `
          ${testId}
          <ul>
              ${data.map((testResult) => `<li>${testResult}</li>`).join('\n')}
          </ul>        
      `
    summaryList.appendChild(li);
  }

  console.info("Starting tests ...");

  runNextTest();
</script>

<style>
  body {
    min-height: 90vh;
    display: flex;
    flex-flow: column;
  }

  iframe {
    flex: 1;
  }
</style>